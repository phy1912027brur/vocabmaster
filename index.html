<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VocabMaster - Master Your Vocabulary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInAnonymously,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            onSnapshot, 
            doc, 
            updateDoc, 
            addDoc, 
            deleteDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDK-KzR5v4pHJ_HaVWQzg4_d58ElbUKkyo",
            authDomain: "study-tracker-3360b.firebaseapp.com",
            projectId: "study-tracker-3360b",
            storageBucket: "study-tracker-3360b.firebasestorage.app",
            messagingSenderId: "814342428382",
            appId: "1:814342428382:web:f27027090057b2f98c544f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'vocab-master-prod';
        const ADMIN_UID = "eNxl56zKYuXfCRumgnFwcF3NANw1";

        let words = [];
        let user = null;
        let currentCategory = '';
        let unsubscribe = null;
        let isAdminView = false;
        let adminSearchQuery = '';

        const refreshIcons = () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        };

        const init = async () => {
            onAuthStateChanged(auth, async (u) => {
                user = u;
                if (!u) {
                    try {
                        await signInAnonymously(auth);
                        return;
                    } catch (e) {
                        console.error("Auth error", e);
                    }
                }
                updateAuthUI();
                loadData();
            });
        };

        const loadData = () => {
            if (unsubscribe) unsubscribe();
            const vocabCol = collection(db, 'artifacts', appId, 'public', 'data', 'vocab');
            
            unsubscribe = onSnapshot(vocabCol, (snapshot) => {
                words = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                        .sort((a, b) => (a.word || '').localeCompare(b.word || ''));
                
                if (isAdminView) {
                    renderAdminPanel();
                } else {
                    renderCategories();
                    renderList();
                }
            }, (error) => {
                console.warn("Firestore error:", error.message);
            });
        };

        const updateAuthUI = () => {
            const btn = document.getElementById('auth-btn');
            const adminBtn = document.getElementById('admin-toggle');
            
            // Check if user exists and is not anonymous (Admin is signed in)
            if (user && !user.isAnonymous) {
                btn.innerHTML = `<i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Logout`;
                // Show settings button only for the specific admin UID
                if (user.uid === ADMIN_UID) {
                    adminBtn.classList.remove('hidden');
                } else {
                    adminBtn.classList.add('hidden');
                }
            } else {
                btn.innerHTML = `<i data-lucide="user" class="w-4 h-4 mr-2"></i> Login`;
                adminBtn.classList.add('hidden');
            }
            refreshIcons();
        };

        const renderCategories = () => {
            const cats = [...new Set(words.map(w => w.category))].filter(Boolean).sort();
            const container = document.getElementById('category-nav');
            if (!currentCategory && cats.length > 0) currentCategory = cats[0];
            
            container.innerHTML = cats.map(cat => `
                <button onclick="setCategory('${cat}')" class="px-4 py-2 rounded-full text-xs font-bold transition-all whitespace-nowrap ${currentCategory === cat ? 'bg-blue-600 text-white shadow-md' : 'bg-white border text-slate-500 hover:bg-slate-50'}">
                    ${cat}
                </button>
            `).join('');
        };

        const renderList = () => {
            const container = document.getElementById('vocab-list');
            const filtered = words.filter(w => w.category === currentCategory);
            
            if (filtered.length === 0) {
                container.innerHTML = `<p class="text-center text-slate-400 text-sm py-10">Kono word paoya jayni.</p>`;
                return;
            }

            container.innerHTML = filtered.map(w => `
                <div onclick="showWordDetails('${w.id}')" class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm flex justify-between items-center cursor-pointer hover:border-blue-300 transition-all group">
                    <div>
                        <h3 class="font-bold text-slate-800 group-hover:text-blue-600 transition-colors">${w.word}</h3>
                        <p class="text-xs text-slate-500">${w.meaning}</p>
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300 group-hover:text-blue-400"></i>
                </div>
            `).join('');
            refreshIcons();
        };

        // --- Admin Functions ---
        window.toggleAdmin = () => {
            isAdminView = !isAdminView;
            const mainView = document.getElementById('main-view');
            const adminPanel = document.getElementById('admin-view');
            const toggleBtn = document.getElementById('admin-toggle');

            if (isAdminView) {
                mainView.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                toggleBtn.classList.add('bg-blue-600', 'text-white');
                renderAdminPanel();
            } else {
                mainView.classList.remove('hidden');
                adminPanel.classList.add('hidden');
                toggleBtn.classList.remove('bg-blue-600', 'text-white');
                renderCategories();
                renderList();
            }
            refreshIcons();
        };

        const renderAdminPanel = () => {
            const tableBody = document.getElementById('admin-table-body');
            const searchQuery = adminSearchQuery.toLowerCase();
            
            const filtered = words.filter(w => 
                w.word?.toLowerCase().includes(searchQuery) || 
                w.meaning?.toLowerCase().includes(searchQuery) ||
                w.category?.toLowerCase().includes(searchQuery)
            );

            tableBody.innerHTML = filtered.map(w => `
                <tr class="border-b border-slate-50 hover:bg-slate-50 transition-colors">
                    <td class="p-3 text-sm font-bold text-slate-700">${w.word}</td>
                    <td class="p-3 text-xs text-slate-500">${w.meaning}</td>
                    <td class="p-3 text-[10px] font-black uppercase text-blue-500">${w.category}</td>
                    <td class="p-3 text-right space-x-2">
                        <button onclick="editWord('${w.id}')" class="text-slate-400 hover:text-blue-600"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                        <button onclick="deleteWord('${w.id}')" class="text-slate-400 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>
            `).join('');
            refreshIcons();
        };

        window.handleAdminSearch = (e) => {
            adminSearchQuery = e.target.value;
            renderAdminPanel();
        };

        window.addWord = async (e) => {
            e.preventDefault();
            const form = e.target;
            const data = {
                word: form.word.value,
                meaning: form.meaning.value,
                category: form.category.value.toUpperCase(),
                synonyms: form.synonyms.value,
                example: form.example.value,
                createdAt: new Date().toISOString()
            };

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'vocab'), data);
                form.reset();
            } catch (err) {
                alert("Error adding word: " + err.message);
            }
        };

        window.deleteWord = async (id) => {
            if (confirm("Apni ki sotti ei word-ti delete korte chan?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'vocab', id));
            }
        };

        window.editWord = (id) => {
            const word = words.find(w => w.id === id);
            if (!word) return;
            
            const newWord = prompt("Word name update:", word.word);
            const newMeaning = prompt("Meaning update:", word.meaning);
            const newCategory = prompt("Category update:", word.category);

            if (newWord && newMeaning && newCategory) {
                updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'vocab', id), {
                    word: newWord,
                    meaning: newMeaning,
                    category: newCategory.toUpperCase()
                });
            }
        };

        // --- Word Details ---
        window.showWordDetails = (id) => {
            const word = words.find(w => w.id === id);
            const modal = document.getElementById('details-modal');
            const content = document.getElementById('details-content');
            
            content.innerHTML = `
                <div class="text-center space-y-4">
                    <span class="px-3 py-1 bg-blue-50 text-blue-600 text-[10px] font-black rounded-full uppercase tracking-widest">${word.category}</span>
                    <h2 class="text-4xl font-black text-slate-800">${word.word}</h2>
                    <p class="text-xl font-bold text-blue-500">${word.meaning}</p>
                    <div class="h-px bg-slate-100 my-4"></div>
                    <div class="text-left space-y-3">
                        <div>
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Synonyms</span>
                            <p class="text-sm text-slate-600">${word.synonyms || 'N/A'}</p>
                        </div>
                        <div>
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Example</span>
                            <p class="text-sm italic text-slate-600">"${word.example || 'No example provided'}"</p>
                        </div>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        window.closeDetails = () => {
            document.getElementById('details-modal').classList.add('hidden');
        };

        window.setCategory = (c) => { currentCategory = c; renderList(); renderCategories(); };
        
        window.toggleAuth = async () => {
            if (user && !user.isAnonymous) {
                try {
                    await signOut(auth);
                    // This will trigger onAuthStateChanged and sign in anonymously automatically
                } catch (err) {
                    console.error("Sign out error", err);
                }
            } else {
                document.getElementById('auth-modal').classList.remove('hidden');
                document.getElementById('auth-modal').classList.add('flex');
            }
        };

        window.handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            const loginBtn = e.target.querySelector('button');
            
            loginBtn.innerText = "Signing in...";
            loginBtn.disabled = true;

            try {
                await signInWithEmailAndPassword(auth, email, pass);
                document.getElementById('auth-modal').classList.add('hidden');
                // State update happens in onAuthStateChanged
            } catch (err) {
                alert("Login failed: " + err.message);
            } finally {
                loginBtn.innerText = "Sign In";
                loginBtn.disabled = false;
            }
        };

        init();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-6">
    <div class="max-w-xl mx-auto">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-2">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-200">
                    <i data-lucide="book-open"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black text-slate-800 leading-none">VocabMaster</h1>
                    <span class="text-[9px] font-black text-blue-500 uppercase tracking-widest">LMS Platform</span>
                </div>
            </div>
            <div class="flex gap-2">
                <button id="admin-toggle" onclick="toggleAdmin()" class="hidden p-2 bg-white border rounded-xl text-slate-400 hover:text-blue-600 transition-colors">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
                <button id="auth-btn" onclick="toggleAuth()" class="px-4 py-2 bg-white border border-slate-100 rounded-xl text-[10px] font-black text-slate-600 hover:border-blue-200 transition shadow-sm uppercase tracking-widest flex items-center">
                    Account
                </button>
            </div>
        </header>

        <!-- Main Student View -->
        <div id="main-view">
            <div class="mb-2">
                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest block mb-3 ml-1">Categories</span>
                <div id="category-nav" class="flex gap-2 overflow-x-auto no-scrollbar mb-6 pb-2"></div>
            </div>
            <div id="vocab-list" class="space-y-3">
                <p class="text-center text-slate-400 text-sm py-10">Loading...</p>
            </div>
        </div>

        <!-- Admin View -->
        <div id="admin-view" class="hidden animate-in fade-in slide-in-from-bottom-4 duration-300">
            <!-- Add New Word Form -->
            <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm mb-6">
                <h2 class="text-sm font-black mb-4 uppercase tracking-widest text-blue-600">Add New Word</h2>
                <form onsubmit="addWord(event)" class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <input name="word" required placeholder="Word" class="p-3 bg-slate-50 border-0 rounded-xl text-sm ring-1 ring-slate-100 focus:ring-2 focus:ring-blue-500 outline-none">
                        <input name="meaning" required placeholder="Meaning" class="p-3 bg-slate-50 border-0 rounded-xl text-sm ring-1 ring-slate-100 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <input name="category" required placeholder="Category (e.g. GRE)" class="p-3 bg-slate-50 border-0 rounded-xl text-sm ring-1 ring-slate-100 focus:ring-2 focus:ring-blue-500 outline-none">
                        <input name="synonyms" placeholder="Synonyms" class="p-3 bg-slate-50 border-0 rounded-xl text-sm ring-1 ring-slate-100 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <textarea name="example" placeholder="Example sentence..." class="w-full p-3 bg-slate-50 border-0 rounded-xl text-sm ring-1 ring-slate-100 focus:ring-2 focus:ring-blue-500 outline-none h-20"></textarea>
                    <button type="submit" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold text-sm shadow-lg shadow-blue-100">Save Word</button>
                </form>
            </div>

            <!-- Admin Table & Search -->
            <div class="bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden">
                <div class="p-4 bg-slate-50/50 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                    <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">Database Records</span>
                    <div class="relative w-full md:w-64">
                        <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input oninput="handleAdminSearch(event)" type="text" placeholder="Search records..." class="w-full pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-full text-xs outline-none focus:border-blue-500">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-slate-50/50">
                                <th class="p-3 text-[9px] font-black uppercase text-slate-400">Word</th>
                                <th class="p-3 text-[9px] font-black uppercase text-slate-400">Meaning</th>
                                <th class="p-3 text-[9px] font-black uppercase text-slate-400">Cat</th>
                                <th class="p-3 text-[9px] font-black uppercase text-slate-400 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="details-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 p-4 items-center justify-center">
        <div class="bg-white w-full max-w-sm rounded-[3rem] p-8 relative shadow-2xl animate-in zoom-in-95 duration-200">
            <button onclick="closeDetails()" class="absolute top-6 right-6 p-2 bg-slate-50 rounded-full text-slate-400 hover:text-slate-600 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            <div id="details-content"></div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] p-4 items-center justify-center">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 relative shadow-2xl">
            <button onclick="this.closest('#auth-modal').classList.add('hidden')" class="absolute top-6 right-6 p-2 bg-slate-100 rounded-full text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h2 class="text-2xl font-black mb-6">Admin Login</h2>
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <input id="login-email" type="email" required placeholder="Email" class="w-full p-4 bg-slate-50 rounded-2xl text-sm border-0 ring-1 ring-slate-100 focus:ring-2 focus:ring-blue-500 outline-none">
                <input id="login-pass" type="password" required placeholder="Password" class="w-full p-4 bg-slate-50 rounded-2xl text-sm border-0 ring-1 ring-slate-100 focus:ring-2 focus:ring-blue-500 outline-none">
                <button type="submit" class="w-full py-4 bg-blue-600 text-white rounded-2xl font-black text-sm shadow-lg shadow-blue-100 transition-all active:scale-95 disabled:opacity-50">Sign In</button>
            </form>
        </div>
    </div>

    <script>lucide.createIcons();</script>
</body>
</html>
