<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VocabMaster - Master Your Vocabulary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Script with fallback check -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInAnonymously,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            onSnapshot, 
            doc, 
            updateDoc, 
            addDoc, 
            deleteDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDK-KzR5v4pHJ_HaVWQzg4_d58ElbUKkyo",
            authDomain: "study-tracker-3360b.firebaseapp.com",
            projectId: "study-tracker-3360b",
            storageBucket: "study-tracker-3360b.firebasestorage.app",
            messagingSenderId: "814342428382",
            appId: "1:814342428382:web:f27027090057b2f98c544f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'vocab-master-prod';
        const ADMIN_UID = "eNxl56zKYuXfCRumgnFwcF3NANw1";

        let words = [];
        let user = null;
        let currentCategory = '';
        let unsubscribe = null;

        // Safe Icon function
        const refreshIcons = () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        };

        // 1. Auth Logic First
        const init = async () => {
            onAuthStateChanged(auth, async (u) => {
                user = u;
                if (!u) {
                    try {
                        await signInAnonymously(auth);
                        return; // Exit, listener will fire again with anonymous user
                    } catch (e) {
                        console.error("Auth error", e);
                    }
                }
                
                // Update UI for user status
                updateAuthUI();
                // 2. Load data only after user is authenticated
                loadData();
            });
        };

        const loadData = () => {
            if (unsubscribe) unsubscribe();
            
            // Critical path based on Rule 1
            const vocabCol = collection(db, 'artifacts', appId, 'public', 'data', 'vocab');
            
            unsubscribe = onSnapshot(vocabCol, (snapshot) => {
                words = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCategories();
                renderList();
            }, (error) => {
                console.warn("Firestore access restricted or pending auth:", error.message);
            });
        };

        const updateAuthUI = () => {
            const btn = document.getElementById('auth-btn');
            if (user && !user.isAnonymous) {
                btn.innerHTML = 'Logout';
                if (user.uid === ADMIN_UID) document.getElementById('admin-toggle').classList.remove('hidden');
            } else {
                btn.innerHTML = 'Account';
                document.getElementById('admin-toggle').classList.add('hidden');
            }
            refreshIcons();
        };

        const renderCategories = () => {
            const cats = [...new Set(words.map(w => w.category))].filter(Boolean);
            const container = document.getElementById('category-nav');
            if (!currentCategory && cats.length > 0) currentCategory = cats[0];
            
            container.innerHTML = cats.map(cat => `
                <button onclick="setCategory('${cat}')" class="px-4 py-2 rounded-full text-xs font-bold ${currentCategory === cat ? 'bg-blue-600 text-white' : 'bg-white border text-slate-500'}">
                    ${cat}
                </button>
            `).join('');
        };

        const renderList = () => {
            const container = document.getElementById('vocab-list');
            const filtered = words.filter(w => w.category === currentCategory);
            
            container.innerHTML = filtered.map(w => `
                <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm flex justify-between items-center">
                    <div>
                        <h3 class="font-bold">${w.word}</h3>
                        <p class="text-xs text-slate-500">${w.meaning}</p>
                    </div>
                </div>
            `).join('');
            refreshIcons();
        };

        window.setCategory = (c) => { currentCategory = c; renderList(); renderCategories(); };
        window.toggleAuth = () => {
            if (user && !user.isAnonymous) signOut(auth);
            else document.getElementById('auth-modal').classList.remove('hidden');
        };

        init();
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #f8fafc; }
    </style>
</head>
<body class="p-6">
    <div class="max-w-md mx-auto">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-xl font-black">VocabMaster</h1>
            <div class="flex gap-2">
                <button id="admin-toggle" class="hidden p-2 bg-white border rounded-xl"><i data-lucide="settings"></i></button>
                <button id="auth-btn" onclick="toggleAuth()" class="px-4 py-2 bg-white border rounded-xl text-xs font-bold uppercase tracking-widest">Account</button>
            </div>
        </header>

        <div id="category-nav" class="flex gap-2 overflow-x-auto mb-6 pb-2"></div>
        <div id="vocab-list" class="space-y-3">
            <p class="text-center text-slate-400 text-sm py-10">Loading vocabulary...</p>
        </div>
    </div>

    <!-- Simple Auth Modal -->
    <div id="auth-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-3xl w-full max-w-xs relative">
             <button onclick="this.closest('#auth-modal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400">âœ•</button>
             <h2 class="text-lg font-bold mb-4">Login</h2>
             <input id="login-email" type="email" placeholder="Email" class="w-full p-3 bg-slate-50 rounded-xl mb-3 text-sm border">
             <input id="login-pass" type="password" placeholder="Password" class="w-full p-3 bg-slate-50 rounded-xl mb-4 text-sm border">
             <button class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold">Sign In</button>
        </div>
    </div>
</body>
</html>
